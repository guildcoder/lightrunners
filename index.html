<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>L I G H T R U N N E R S Core Prototype</title>
<style>
html, body { margin:0; padding:0; overflow:hidden; background:black; }
canvas { display:block; background:#0f0f0f; }

.joystick, .fireButton, .mountButton {
  position:absolute; touch-action:none; user-select:none;
}
.joystick { width:120px; height:120px; border-radius:50%; background: rgba(255,255,255,0.2); bottom:30px; left:30px;}
.fireButton { width:80px; height:80px; border-radius:50%; background: rgba(255,0,0,0.3); bottom:40px; right:30px;}
.mountButton { width:120px; height:50px; border-radius:10px; background: rgba(0,255,255,0.3); bottom:150px; right:30px; text-align:center; line-height:50px; font-weight:bold; color:white; font-family:sans-serif;}
@media (pointer: fine) { .joystick, .fireButton, .mountButton { display:none; } }
</style>
</head>
<body>

<canvas id="gameCanvas" width="900" height="600"></canvas>
<div class="joystick" id="joystick"></div>
<div class="fireButton" id="fireButton"></div>
<div class="mountButton" id="mountButton">Get In/Out</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// --- Keyboard ---
const keys = {};
document.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

// --- Player & Bike ---
const player = { x:500, y:500, size:20, speed:2, onBike:false, direction:-Math.PI/2 };
const bike = { x:500, y:500, width:40, height:20, speed:5, trail:[], mounted:false };

// --- Bots ---
const bots = [
  {x:300, y:300, width:20, height:30, speed:1, dirX:1, dirY:0, state:'neutral', aggroTime:0}
];
const copBots = [];

// --- Discs ---
const discs = [];

// --- Mobile controls ---
const joystick = document.getElementById('joystick');
const fireButton = document.getElementById('fireButton');
const mountButton = document.getElementById('mountButton');

let touchDir = { x:0, y:0 };
joystick.addEventListener('touchstart', handleTouch);
joystick.addEventListener('touchmove', handleTouch);
joystick.addEventListener('touchend', ()=>touchDir={x:0,y:0});
function handleTouch(e){
  const touch = e.touches[0];
  const rect = joystick.getBoundingClientRect();
  const cx = rect.left + rect.width/2;
  const cy = rect.top + rect.height/2;
  touchDir.x = Math.max(-1, Math.min(1, (touch.clientX-cx)/60));
  touchDir.y = Math.max(-1, Math.min(1, (touch.clientY-cy)/60));
  e.preventDefault();
}

let firePressed = false;
fireButton.addEventListener('touchstart', ()=>firePressed=true);
fireButton.addEventListener('touchend', ()=>firePressed=false);

mountButton.addEventListener('touchstart', toggleBike);
document.addEventListener('keydown', e => { if(e.key.toLowerCase()==='r') toggleBike(); });

function toggleBike(){
  player.onBike = !player.onBike;
  bike.mounted = player.onBike;
  if(bike.mounted){ bike.x = player.x; bike.y = player.y; }
}

// --- Grid ---
function drawGrid(camX, camY){
  const gridSize = 50;
  ctx.strokeStyle = 'rgba(0,255,255,0.1)';
  ctx.lineWidth = 1;
  for(let x=-camX%gridSize;x<canvas.width;x+=gridSize){
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke();
  }
  for(let y=-camY%gridSize;y<canvas.height;y+=gridSize){
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke();
  }
}

// --- Update Player & Bike ---
function updatePlayer(){
  const spd = player.onBike ? bike.speed : player.speed;

  // Keyboard movement
  if(keys['w'] || keys['arrowup']) { player.y -= spd; player.direction=-Math.PI/2; }
  if(keys['s'] || keys['arrowdown']) { player.y += spd; player.direction=Math.PI/2; }
  if(keys['a'] || keys['arrowleft']) { player.x -= spd; player.direction=Math.PI; }
  if(keys['d'] || keys['arrowright']) { player.x += spd; player.direction=0; }

  // Mobile movement
  player.x += touchDir.x*spd;
  player.y += touchDir.y*spd;
  if(touchDir.x!==0 || touchDir.y!==0) player.direction=Math.atan2(touchDir.y,touchDir.x);

  // Bike updates
  if(player.onBike){
    bike.x = player.x;
    bike.y = player.y;
    bike.trail.push({x: bike.x, y: bike.y, time:Date.now()});
    bike.trail = bike.trail.filter(t=>Date.now()-t.time<3000);
  }

  // Fire discs
  if(firePressed && player.onBike){
    discs.push({x:bike.x, y:bike.y, angle:player.direction, speed:8, time:Date.now()});
    firePressed=false;
  }
}

// --- Update Bots ---
function updateBots(){
  bots.forEach(bot=>{
    if(bot.state==='neutral'){
      bot.x += bot.dirX*bot.speed;
      bot.y += bot.dirY*bot.speed;
      if(bot.x<0||bot.x+bot.width>2000) bot.dirX*=-1;
      if(bot.y<0||bot.y+bot.height>2000) bot.dirY*=-1;
    } else if(bot.state==='aggro'){
      const dx=player.x-bot.x;
      const dy=player.y-bot.y;
      const dist=Math.hypot(dx,dy);
      bot.x += dx/dist*bot.speed*1.5;
      bot.y += dy/dist*bot.speed*1.5;
      if(Date.now()>bot.aggroTime) bot.state='neutral';
    }
  });
  // Cop bots
  copBots.forEach(bot=>{
    const dx=player.x-bot.x;
    const dy=player.y-bot.y;
    const dist=Math.hypot(dx,dy);
    bot.x += dx/dist*bot.speed*2;
    bot.y += dy/dist*bot.speed*2;
  });
}

// --- Update Discs ---
function updateDiscs(){
  for(let i=discs.length-1;i>=0;i--){
    const d = discs[i];
    d.x += Math.cos(d.angle)*d.speed;
    d.y += Math.sin(d.angle)*d.speed;

    // Hit bots
    bots.forEach(bot=>{
      if(d.x>bot.x && d.x<bot.x+bot.width && d.y>bot.y && d.y<bot.y+bot.height){
        bot.state='aggro';
        bot.aggroTime = Date.now()+5000;
        discs.splice(i,1);
      }
    });
    if(Date.now()-d.time>3000) discs.splice(i,1);
  }
}

// --- Draw ---
function draw(){
  const camX = player.x - canvas.width/2;
  const camY = player.y - canvas.height/2;

  drawGrid(camX, camY);

  // Player
  ctx.fillStyle='white';
  ctx.fillRect(player.x-camX-player.size/2, player.y-camY-player.size/2, player.size, player.size);

  // Bike & trail
  if(player.onBike){
    bike.trail.forEach(t=>{
      const age=(Date.now()-t.time)/3000;
      ctx.fillStyle=`rgba(0,255,255,${1-age})`;
      ctx.fillRect(t.x-camX-5, t.y-camY-5, 10,10);
    });
    ctx.fillStyle='cyan';
    ctx.fillRect(bike.x-camX-bike.width/2, bike.y-camY-bike.height/2, bike.width, bike.height);
  }

  // Bots
  ctx.fillStyle='red';
  bots.forEach(bot=>ctx.fillRect(bot.x-camX, bot.y-camY, bot.width, bot.height));
  ctx.fillStyle='orange';
  copBots.forEach(bot=>ctx.fillRect(bot.x-camX, bot.y-camY, bot.width, bot.height));

  // Discs
  ctx.fillStyle='yellow';
  discs.forEach(d=>ctx.fillRect(d.x-camX-5, d.y-camY-5, 10,10));
}

// --- Loop ---
function loop(){
  updatePlayer();
  updateBots();
  updateDiscs();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
